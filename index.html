<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetGuard Server</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for efficient screen usage */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden selection:bg-cyan-500 selection:text-slate-900">

    <!-- Header: Fixed height -->
    <header class="bg-slate-900 border-b border-slate-800 p-4 shadow-lg shrink-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-cyan-500/10 p-2 rounded-lg border border-cyan-500/20 shadow-[0_0_15px_rgba(6,182,212,0.15)]">
                    <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-100 tracking-tight leading-none">NetGuard</h1>
                    <p class="text-[10px] text-slate-500 font-mono uppercase tracking-widest mt-1">Server Manager</p>
                </div>
            </div>
            <div id="status-badge" class="px-3 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-2 border bg-rose-500/10 text-rose-400 border-rose-500/20 transition-all duration-300">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-rose-400 shadow-[0_0_10px_currentColor]"></span>
                <span id="status-text">Offline</span>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto lg:overflow-hidden bg-slate-950/50">
        <div class="container mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
            
            <!-- Left Column (Controls) -->
            <div class="lg:col-span-4 space-y-6 flex flex-col lg:h-full lg:overflow-y-auto pr-1">
                
                <!-- Server Control Panel -->
                <section class="bg-slate-900 rounded-xl border border-slate-800 shadow-xl overflow-hidden shrink-0">
                    <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                        <h2 class="font-semibold text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wide">
                            <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg> 
                            Control
                        </h2>
                    </div>
                    <div class="p-5 space-y-5">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-950 p-3 rounded-lg border border-slate-800 group focus-within:border-cyan-500/50 transition-colors">
                                <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Port</span>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-slate-600">#</span>
                                    <input type="number" id="port-input" value="8080" class="bg-transparent w-full font-mono text-lg text-slate-200 focus:outline-none placeholder-slate-700">
                                </div>
                            </div>
                            <div class="bg-slate-950 p-3 rounded-lg border border-slate-800">
                                <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Uptime</span>
                                <div id="uptime-display" class="font-mono text-lg text-slate-200 mt-1 tabular-nums">00:00:00</div>
                            </div>
                        </div>

                        <button id="toggle-server-btn" class="w-full py-4 rounded-lg font-bold text-sm uppercase tracking-widest transition-all duration-300 flex items-center justify-center gap-3 shadow-lg bg-emerald-600 hover:bg-emerald-500 text-white hover:shadow-[0_0_20px_rgba(16,185,129,0.3)] active:scale-[0.98]">
                            <svg id="play-icon" class="w-5 h-5 fill-current block" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg id="stop-icon" class="w-5 h-5 fill-current hidden" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
                            <span id="btn-text">Start Server</span>
                        </button>
                    </div>
                </section>

                <!-- Firewall List Panel -->
                <section class="bg-slate-900 rounded-xl border border-slate-800 shadow-xl overflow-hidden flex flex-col flex-1 min-h-[350px]">
                    <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center shrink-0">
                        <h2 class="font-semibold text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wide">
                            <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Allowlist
                        </h2>
                        <span id="ip-count" class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded-full font-mono">0</span>
                    </div>
                    
                    <div class="p-4 border-b border-slate-800 bg-slate-900/80 shrink-0">
                        <form id="add-ip-form" class="flex gap-2 relative">
                            <input type="text" id="new-ip-input" placeholder="e.g. 192.168.1.50" class="flex-1 bg-slate-950 border border-slate-700 rounded-lg px-4 py-2.5 text-sm text-slate-200 placeholder-slate-600 focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all font-mono">
                            <button type="submit" class="bg-cyan-600 hover:bg-cyan-500 text-white px-3 rounded-lg transition-colors shadow-lg shadow-cyan-900/20 active:translate-y-0.5">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </button>
                        </form>
                    </div>

                    <div id="ip-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                        <!-- Dynamic Content -->
                    </div>
                </section>
            </div>

            <!-- Right Column (Sim & Logs) -->
            <div class="lg:col-span-8 space-y-6 flex flex-col lg:h-full lg:overflow-hidden">
                
                <!-- Simulator Panel -->
                <section class="bg-slate-900 rounded-xl border border-slate-800 shadow-xl overflow-hidden shrink-0">
                    <div class="p-4 border-b border-slate-800 bg-slate-900/50">
                        <h2 class="font-semibold text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wide">
                            <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Traffic Simulator
                        </h2>
                    </div>
                    <div class="p-5">
                        <div class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-end">
                            <div class="flex-1 w-full">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-wider">Simulate Incoming IP</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-4 w-4 text-slate-600 group-focus-within:text-cyan-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                                    </div>
                                    <input type="text" id="sim-ip-input" placeholder="0.0.0.0" class="w-full bg-slate-950 border border-slate-700 rounded-lg pl-10 pr-4 py-3 text-slate-200 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all font-mono">
                                </div>
                            </div>
                            <button id="test-access-btn" class="w-full sm:w-auto px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold text-sm uppercase tracking-wider transition-all shadow-lg shadow-indigo-900/30 active:scale-[0.98] flex items-center justify-center whitespace-nowrap">
                                Test Access
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Logs Panel -->
                <section class="bg-slate-950 rounded-xl border border-slate-800 shadow-2xl overflow-hidden flex flex-col flex-1 min-h-[300px] lg:min-h-0 relative">
                    <div class="p-3 border-b border-slate-800 bg-slate-900 flex justify-between items-center shrink-0">
                        <h2 class="font-mono text-xs font-semibold text-slate-400 flex items-center gap-2 uppercase">
                            <span class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></span>
                            Live Events
                        </h2>
                        <button id="clear-logs-btn" class="px-2 py-1 text-[10px] font-bold uppercase tracking-wider text-slate-500 hover:text-slate-200 hover:bg-slate-800 rounded transition-colors">Clear Logs</button>
                    </div>
                    
                    <!-- Scrollable Log Container -->
                    <div id="log-container" class="flex-1 overflow-y-auto p-4 font-mono text-sm space-y-1.5 scroll-smooth">
                        <div class="text-slate-700 text-center mt-12 select-none italic text-xs">// System Ready. Waiting for traffic...</div>
                    </div>
                    
                    <!-- Decorative gradient fade at bottom -->
                    <div class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-slate-950 to-transparent pointer-events-none"></div>
                </section>

            </div>
        </div>
    </main>

    <script>
        // ‚úÖ FIXED: Import ipcRenderer from electron
        const { ipcRenderer } = require('electron');

        // --- State ---
        let isServerRunning = false;
        let uptimeSeconds = 0;
        let uptimeInterval = null;
        let allowedIPs = ['127.0.0.1', '::1'];

        // --- Elements ---
        const els = {
            toggleBtn: document.getElementById('toggle-server-btn'),
            btnText: document.getElementById('btn-text'),
            playIcon: document.getElementById('play-icon'),
            stopIcon: document.getElementById('stop-icon'),
            statusBadge: document.getElementById('status-badge'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            portInput: document.getElementById('port-input'),
            uptimeDisplay: document.getElementById('uptime-display'),
            ipList: document.getElementById('ip-list'),
            addIpForm: document.getElementById('add-ip-form'),
            newIpInput: document.getElementById('new-ip-input'),
            ipCount: document.getElementById('ip-count'),
            simIpInput: document.getElementById('sim-ip-input'),
            testBtn: document.getElementById('test-access-btn'),
            logContainer: document.getElementById('log-container'),
            clearLogsBtn: document.getElementById('clear-logs-btn')
        };

        // --- Functions ---

        function updateUI() {
            if (isServerRunning) {
                // Server ON State
                els.toggleBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-500', 'hover:shadow-[0_0_20px_rgba(16,185,129,0.3)]');
                els.toggleBtn.classList.add('bg-rose-600', 'hover:bg-rose-500', 'hover:shadow-[0_0_20px_rgba(225,29,72,0.3)]');
                els.btnText.textContent = "Stop Server";
                els.playIcon.classList.add('hidden');
                els.stopIcon.classList.remove('hidden');
                els.portInput.disabled = true;
                els.portInput.classList.add('opacity-50', 'cursor-not-allowed');
                
                els.statusBadge.className = "px-3 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-2 border bg-emerald-500/10 text-emerald-400 border-emerald-500/20 transition-all duration-300";
                els.statusDot.className = "w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_10px_currentColor] animate-pulse";
                els.statusText.textContent = "Online";
            } else {
                // Server OFF State
                els.toggleBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-500', 'hover:shadow-[0_0_20px_rgba(16,185,129,0.3)]');
                els.toggleBtn.classList.remove('bg-rose-600', 'hover:bg-rose-500', 'hover:shadow-[0_0_20px_rgba(225,29,72,0.3)]');
                els.btnText.textContent = "Start Server";
                els.playIcon.classList.remove('hidden');
                els.stopIcon.classList.add('hidden');
                els.portInput.disabled = false;
                els.portInput.classList.remove('opacity-50', 'cursor-not-allowed');

                els.statusBadge.className = "px-3 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-2 border bg-rose-500/10 text-rose-400 border-rose-500/20 transition-all duration-300";
                els.statusDot.className = "w-2 h-2 rounded-full bg-rose-400 shadow-[0_0_10px_currentColor]";
                els.statusText.textContent = "Offline";
            }
        }

        function renderIPs() {
            els.ipList.innerHTML = '';
            els.ipCount.textContent = `${allowedIPs.length}`;
            
            if (allowedIPs.length === 0) {
                els.ipList.innerHTML = '<div class="text-center p-8 text-slate-600 text-xs italic">No IPs whitelisted.<br/>All traffic blocked.</div>';
                return;
            }

            allowedIPs.forEach(ip => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-3 rounded-lg bg-slate-950/50 hover:bg-slate-800 border border-slate-800 hover:border-slate-600 transition-all group fade-in mb-2";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></div>
                        <span class="font-mono text-sm text-slate-300 tracking-tight">${ip}</span>
                    </div>
                    <button onclick="removeIP('${ip}')" class="text-slate-600 hover:text-rose-400 p-1 rounded hover:bg-rose-500/10 transition-colors" title="Remove IP">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                els.ipList.appendChild(div);
            });
        }

        function addLog(type, message) {
            // Remove empty state if present
            const firstChild = els.logContainer.children[0];
            if (firstChild && firstChild.classList.contains('text-center')) {
                els.logContainer.innerHTML = '';
            }

            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const div = document.createElement('div');
            div.className = "flex gap-3 fade-in group hover:bg-white/5 p-1 rounded -mx-1";
            
            let colorClass = "text-slate-300";
            let icon = "";
            
            if (type === 'system') { 
                colorClass = "text-cyan-400"; 
                icon = "‚ÑπÔ∏è"; 
            }
            if (type === 'error') { 
                colorClass = "text-rose-500 font-bold"; 
                icon = "‚ö†Ô∏è"; 
            }
            if (type === 'blocked') { 
                colorClass = "text-orange-400"; 
                icon = "üö´"; 
            }
            if (type === 'success') { 
                colorClass = "text-emerald-400"; 
                icon = "‚úÖ"; 
            }

            div.innerHTML = `
                <span class="text-slate-600 text-xs py-0.5 font-mono select-none">[${timestamp}]</span>
                <div class="flex-1 break-all ${colorClass}">
                    <span class="opacity-50 mr-1 select-none">${icon}</span>${message}
                </div>
            `;
            
            els.logContainer.appendChild(div);
            
            // Auto-Scroll
            requestAnimationFrame(() => {
                els.logContainer.scrollTop = els.logContainer.scrollHeight;
            });
        }

        function formatUptime(s) {
            const h = Math.floor(s / 3600).toString().padStart(2,'0');
            const m = Math.floor((s % 3600) / 60).toString().padStart(2,'0');
            const sec = (s % 60).toString().padStart(2,'0');
            return `${h}:${m}:${sec}`;
        }

        // --- Event Listeners ---

        els.toggleBtn.addEventListener('click', () => {
            if (isServerRunning) {
                // Stop
                isServerRunning = false;
                clearInterval(uptimeInterval);
                uptimeSeconds = 0;
                els.uptimeDisplay.textContent = "00:00:00";
                addLog('system', 'Server stopped.');
                
                // ‚úÖ FIXED: Send IPC to main process
                ipcRenderer.send('toggle-server', { running: false, port: els.portInput.value });
            } else {
                // Start
                isServerRunning = true;
                const port = els.portInput.value;
                addLog('system', `Server starting on port ${port}. Firewall active.`);
                
                // ‚úÖ FIXED: Send IPC to main process
                ipcRenderer.send('toggle-server', { running: true, port: parseInt(port) });
                
                uptimeInterval = setInterval(() => {
                    uptimeSeconds++;
                    els.uptimeDisplay.textContent = formatUptime(uptimeSeconds);
                }, 1000);
            }
            updateUI();
        });

        els.addIpForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const ip = els.newIpInput.value.trim();
            if (!ip) return;
            
            const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$|^::1$|^::ffff:/;
            
            if (!ipRegex.test(ip)) {
                 addLog('error', `Invalid IP format: ${ip}`);
                 return;
            }

            if (allowedIPs.includes(ip)) {
                addLog('error', `IP ${ip} is already whitelisted.`);
                return;
            }
            
            allowedIPs.push(ip);
            renderIPs();
            els.newIpInput.value = '';
            addLog('system', `Added ${ip} to allowlist.`);
            
            // ‚úÖ FIXED: Send updated allowlist to main process
            ipcRenderer.send('update-allowlist', allowedIPs);
        });

        window.removeIP = (ip) => {
            allowedIPs = allowedIPs.filter(i => i !== ip);
            renderIPs();
            addLog('system', `Removed ${ip} from allowlist.`);
            
            // ‚úÖ FIXED: Send updated allowlist to main process
            ipcRenderer.send('update-allowlist', allowedIPs);
        };

        els.testBtn.addEventListener('click', () => {
            const ip = els.simIpInput.value.trim();
            if (!ip) {
                addLog('error', 'Please enter an IP address');
                return;
            }

            if (!isServerRunning) {
                addLog('error', `Connection refused from ${ip} (Server Offline)`);
                return;
            }

            if (allowedIPs.includes(ip)) {
                addLog('success', `Access GRANTED for ${ip}`);
            } else {
                addLog('blocked', `Access DENIED for ${ip} (Firewall Block)`);
            }
        });

        els.clearLogsBtn.addEventListener('click', () => {
            els.logContainer.innerHTML = '<div class="text-slate-700 text-center mt-12 select-none italic text-xs">// Logs cleared.</div>';
        });

        // ‚úÖ FIXED: Listen for log entries from main process
        ipcRenderer.on('log-entry', (event, data) => {
            console.log('üì® Log from server:', data);
            addLog(data.type, data.message);
        });

        // ‚úÖ FIXED: Listen for server status updates
        ipcRenderer.on('server-status', (event, data) => {
            console.log('üìä Server status:', data);
            if (data.running) {
                isServerRunning = true;
                addLog('system', `‚úÖ Server is now running on port ${data.port}`);
            } else {
                isServerRunning = false;
                clearInterval(uptimeInterval);
                uptimeSeconds = 0;
                els.uptimeDisplay.textContent = "00:00:00";
                addLog('system', '‚ùå Server stopped');
            }
            updateUI();
        });

        // --- Init ---
        renderIPs();
        updateUI();
        addLog('system', 'NetGuard initialized. Ready to start server.');

    </script>
</body>
</html>
